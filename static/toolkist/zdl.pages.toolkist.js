import {toolkist} from '/toolkist/toolkist.js';

var gistDummy = 
{
    "tiers": {
        "S": "#9603ff",
        "A": "#d103ff",
        "B": "#ff0364",
        "C": "#ff0303",
        "D": "#ff3e03",
        "E": "#ff9203",
        "F": "#ffd103",
        "G": "#e2ff03",
        "H": "#46ff03",
        "I": "#03ff96",
        "J": "#03e6ff",
        "K": "#0381ff",
        "X": "#ffd103"
    },
    "lists": {
        "main": [
            {
                "name": "my corn dried up '^'",
                "displayName": "",
                "hash": "F154859E514D27715E2E9DA272158FF758909C48",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    },
                    {
                        "user": "RoundNzt"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "S"
            },
            {
                "name": "Jungle Jam 3",
                "displayName": "",
                "hash": "CAA57574C2381FBF78DADC87CE7FBE7C4127C659",
                "manualRecords": [
                    {
                        "user": "Sandals"
                    },
                    {
                        "user": "RoundNzt"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "S"
            },
            {
                "name": "my corn thawed out -_-",
                "displayName": "",
                "hash": "C1F3FAF5061DC76796D465AD1B885A39EDF267D0",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "A"
            },
            {
                "name": "Red Dread",
                "displayName": "",
                "hash": "7065C9A24467A6F1E586B820E49D2C22B120A6CD",
                "manualRecords": [
                    {
                        "user": "justMaki"
                    },
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "B"
            },
            {
                "name": "Trail Of The Original Dragon",
                "displayName": "",
                "hash": "3D920C0A60ECCF3A6CC3CBE66F84AE4B8D9C8D26",
                "manualRecords": [
                    {
                        "user": "justMaki"
                    },
                    {
                        "user": "flying_pancake12"
                    },
                    {
                        "user": "Sandals"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "B"
            },
            {
                "name": "my corn froze over `,(",
                "displayName": "",
                "hash": "7EEEDE5635671396818E45124674C508FAA0FD2A",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "B"
            },
            {
                "name": "Cosmic Bobcheck",
                "displayName": "",
                "hash": "85406B1E47E5BFA7F53799A57C288F9A893C7589",
                "manualRecords": [
                    {
                        "user": "readfreak7"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "B"
            },
            {
                "name": "Idolize",
                "displayName": "",
                "hash": "7F9E5AF31AF94C0B3BB2E71A3DDB80A4DE89C92B",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "C"
            },
            {
                "name": "The Long Awaited Moment",
                "displayName": "",
                "hash": "46B9779CC605CD81421FAE7E8643EE4632026EE1",
                "manualRecords": [
                    {
                        "user": "Sandals"
                    },
                    {
                        "user": "justMaki"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Jungle Jam 2",
                "displayName": "",
                "hash": "FE3E717D25E0AC7AFDC439C9D63537C038AD99C2",
                "manualRecords": [
                    {
                        "user": "Sandals"
                    },
                    {
                        "user": "[CTR] LupensCruor"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Brake-Tech",
                "displayName": "",
                "hash": "ABD60CAA38ED6DFBFE2EEACEBB415B7C09599933",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Extremely Critical Heat",
                "displayName": "",
                "hash": "A5AFA60BA3967DF72ED16B04BF01BD1D4C2DD294",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Fleshmouth",
                "displayName": "",
                "hash": "",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Because we were inspired by HONR we would like to carry on their legacy",
                "displayName": "",
                "hash": "A890583AF0E220CA192E7C896AB6A54BFC1D44F5",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "my corn got wet ;-;",
                "displayName": "",
                "hash": "358E57EFF233B447BC25B772B9513ECC1D86CCCF",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "D"
            },
            {
                "name": "Early Autumn",
                "displayName": "",
                "hash": "B0B6C4725A01A69779ED107248A44EF6F8B4E575",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "pruina impetum",
                "displayName": "",
                "hash": "3D75FF3D2132556C73873DC915930CD2F2E7DA9B",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    },
                    {
                        "user": "Sandals"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "dork detection & denial service",
                "displayName": "",
                "hash": "D1F6F7DB2E2D9AB596938DBDB018C03B96B32B55",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "Arctic Mammoth",
                "displayName": "",
                "hash": "682C703966C55AD3595A4E3DBA75F4080DB03523",
                "manualRecords": [
                    {
                        "user": "[CTR]Cbad Cruiser"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "antrum desideratum",
                "displayName": "",
                "hash": "A319962485E74BD49B0922ED8D57D2C9D8788643",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "Paradise Island",
                "displayName": "",
                "hash": "18FE545D9F5418CE35FB6D3ED17B2ACB5DE35593",
                "manualRecords": [
                    {
                        "user": "Sandals"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "ZeepStep",
                "displayName": "",
                "hash": "BEF50D66CFE1C059F15527D1BF77BA2D0F78AF9A",
                "manualRecords": [
                    {
                        "user": "Last"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "E"
            },
            {
                "name": "Enigma",
                "displayName": "",
                "hash": "11A6BF56475117E499F2FA2665BEEEDA64D801AB",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Nasty Suprise",
                "displayName": "",
                "hash": "0DCE150A0F29B3BFA354CD698827D6C55D2472EE",
                "manualRecords": [
                    {
                        "user": "thespyeye"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Chilled Quarry",
                "displayName": "",
                "hash": "0A9971123E09E249BE0CB225E8F71D3187BE4F68",
                "manualRecords": [
                    {
                        "user": "Hydro"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "EdgeCheck",
                "displayName": "",
                "hash": "71949514F11B704910E9EC0D7FF3607DCE8D6E49",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Grand Reunion",
                "displayName": "",
                "hash": "C73CFFBC347EDF70F08F09AC7CE01AE60080D74B",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    },
                    {
                        "user": "justMaki"
                    },
                    {
                        "user": "Last"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Prismatic Sojourn, Ascension of the Geometric Symphony",
                "displayName": "",
                "hash": "97FEBD159E6BA86B25A80445C2035B413BDFBD05",
                "manualRecords": [
                    {
                        "user": "Jakie"
                    },
                    {
                        "user": "PoleLord"
                    },
                    {
                        "user": "Sandals"
                    },
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Ice to Meat You",
                "displayName": "",
                "hash": "4335BB5A576658BB0E80CA673B2F392F1A632817",
                "manualRecords": [
                    {
                        "user": "Lexer"
                    },
                    {
                        "user": "Sandals"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Welcome to your worst nightmare",
                "displayName": "",
                "hash": "2EAAB2E4932D244E9D86EC2860E800F10C7FF1C7",
                "manualRecords": [
                    {
                        "user": "Hydro"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Fading Memory",
                "displayName": "",
                "hash": "636B4F62551FC115D1D11129E956E07BED486373",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "Slipcheck",
                "displayName": "",
                "hash": "DBD07F8F203D6932FBEC4B1E14488714C1B5DC9B",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "F"
            },
            {
                "name": "dried dogwater",
                "displayName": "",
                "hash": "",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "bloody puddles",
                "displayName": "",
                "hash": "13A898002A83A582371899B727D7824A28E8BEA2",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "roader's desert ,,",
                "displayName": "",
                "hash": "B5BAC970B445B7F65DD8B1D4EF5380DFBB6E7F5C",
                "manualRecords": [
                    {
                        "user": "justMaki"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "Jungle Jam Tilted",
                "displayName": "",
                "hash": "3978BEDBDF86837CE6936D06B92AC616386FFACC",
                "manualRecords": [
                    {
                        "user": "Sandals"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "Jungle Jam",
                "displayName": "",
                "hash": "A51CD52AB56D7DDF5DC13B28CB3A3CDBCB09428D",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "I Didn't Listen To Kernkob",
                "displayName": "",
                "hash": "96DDF7E579EE4E9588B9171DDA299A8568FC9DB9",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "Collect All Pets",
                "displayName": "",
                "hash": "91E1468F86945EB3CBE443AE9F202234CC464218",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "Ice to meet you (ft Maki)",
                "displayName": "",
                "hash": "CA34CB0B82BF9C83592479000FBA8BF2607E91D1",
                "manualRecords": [
                    {
                        "user": "[CTR] L3it3R"
                    },
                    {
                        "user": "justMaki"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "G"
            },
            {
                "name": "lucifid",
                "displayName": "",
                "hash": "4991565A843380983B0D21475BA992AC7A9EECDD",
                "manualRecords": [
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "H"
            },
            {
                "name": "BobCheck",
                "displayName": "",
                "hash": "9C28C9AAC37CD77AE1A0386AA9BE9EB9BBA8ECEB",
                "manualRecords": [
                    {
                        "user": "Partheniki"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "I"
            },
            {
                "name": "Soap Hell",
                "displayName": "",
                "hash": "FED8EB95355E6452931B0487FAA3C3EF59978DC6",
                "manualRecords": [
                    {
                        "user": "Odist"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "I"
            },
            {
                "name": "gelida smaragdi reliquiae",
                "displayName": "",
                "hash": "00F0A9DB366078AD780BE2DF2F636B0851BD7106",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "I"
            },
            {
                "name": "Mount Pain",
                "displayName": "",
                "hash": "71284F19F2194456B4F144B23EC40D6DCFC22162",
                "manualRecords": [
                    {
                        "user": "Greil"
                    },
                    {
                        "user": "PoleLord"
                    },
                    {
                        "user": "Jakie"
                    },
                    {
                        "user": "GrimServers"
                    },
                    {
                        "user": "BearChills"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "I"
            },
            {
                "name": "Ronans_Tears_v3",
                "displayName": "",
                "hash": "F1CAF3C5D82ACD465AADD3818B0322C00F028147",
                "manualRecords": [
                    {
                        "user": "justMaki"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "I"
            },
            {
                "name": "Childs Play Thing",
                "displayName": "",
                "hash": "59FEFD397B51CB9CFB0A1DA46765685C459F3C44",
                "manualRecords": [
                    {
                        "user": "[CTR] L3it3R"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "J"
            },
            {
                "name": "Frozen Landscape",
                "displayName": "",
                "hash": "EC4061DCC1FCF9794297829BDFB4068A2B843DDD",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "J"
            },
            {
                "name": "LMAOU_TECH",
                "displayName": "",
                "hash": "20EB77B2D304264CB6E023E94B8A34B4A0A57204",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "J"
            },
            {
                "name": "roader's desert ,",
                "displayName": "",
                "hash": "A617E92BC3F9E2A3A069C92A4407717B4DEA05ED",
                "manualRecords": [
                    {
                        "user": "justMaki"
                    },
                    {
                        "user": "Kernkob"
                    }
                ],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "J"
            }
        ],
        "legacy": [
            {
                "name": "Camembert",
                "displayName": "",
                "hash": "1854DDF48DFD5A7796896C589AE551C91F1131AC",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "Joining the Dark Side But Not Fully Committing",
                "displayName": "",
                "hash": "404A3E243CCE8B2653BF4FB02087EDB8B4B66AE0",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "done with dunes",
                "displayName": "",
                "hash": "7627F6A23FFCB523D617944E4E65F66BD0521133",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "Fresh Blue Fun",
                "displayName": "",
                "hash": "402AEAED0375C99142FDEBD835A5CF651F87DBB1",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "L'maoukiberge - Bloody Frozen Nightmare",
                "displayName": "",
                "hash": "EBC8200BF1E5F170BA80BC48D759681A7C7EFF26",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "Janksitions",
                "displayName": "",
                "hash": "9461AD1FBCBC4CB798B9D208FEBCAB7509522BA8",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "Looped - High Hell",
                "displayName": "",
                "hash": "AF805BE258F784C1A04AFC41B3C532DACEF22D67",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            },
            {
                "name": "Neon Hell",
                "displayName": "",
                "hash": "51A611086CE3E6EA10CCC395B8FC8312F92D1339",
                "manualRecords": [],
                "manualCreators": [],
                "manualValidation": 0,
                "description": "...",
                "tier": "X"
            }
        ]
    }
}

//List of player objects from GTR.
var playerData = null;
var mainPlaylist = null;
var legacyPlaylist = null;
var gist = null;
var useDummyData = false;

$(document).ready(function()
{
    toolkist.api.GetZDLGist(function(gistData)
    {
        if(useDummyData)
        {
            gistData = gistDummy;
            console.log("Using Dummy Data");
        }

        if(gistData == null)
        {
            console.log("ERROR");
        }
        else
        {
            gist = gistData;

            //First get the player data.
            toolkist.api.GetPlayerData(data => 
            {
                playerData = data;

                //Get the level and record data for the main list.
                GetLevelRecords(gist.lists.main, function(mainData)
                {     
                    //Get the level and record data for the legacy list.
                    GetLevelRecords(gist.lists.legacy, function(legacyData)
                    {
                        RenderZDLList('#zdlMainList', mainData, 'main');
                        RenderZDLList('#zdlLegacyList', legacyData, 'legacy');
                        RenderZDLScoreboard('#zdlScoreboard', mainData);

                        mainPlaylist = new toolkist.game.Playlist();
                        mainPlaylist.SetProperties({name: "ZDL Main Levels", roundLength: 600, shuffle: false});
                        mainData.forEach(level =>
                        {
                            mainPlaylist.AddLevel(level.uid, level.workshopId, level.name, level.fileAuthor);
                        });

                        legacyPlaylist = new toolkist.game.Playlist();
                        legacyPlaylist.SetProperties({name: "ZDL Legacy Levels", roundLength: 600, shuffle: false});
                        legacyData.forEach(level =>
                        {
                            legacyPlaylist.AddLevel(level.uid, level.workshopId, level.name, level.fileAuthor);
                        })

                        toolkist.html.RenderHeaderBlock('.standardLeftPanel', 'Pages');
                        toolkist.html.RenderButton('.standardLeftPanel', 'mainLevelsButton', 'Main Levels');
                        toolkist.html.RenderButton('.standardLeftPanel', 'legacyLevelsButton', 'Legacy Levels');
                        toolkist.html.RenderButton('.standardLeftPanel', 'scoreboardButton', 'Scoreboard');
                        toolkist.html.RenderHeaderBlock('.standardLeftPanel', 'Playlists');
                        toolkist.html.RenderButton('.standardLeftPanel', 'mainLevelsPlaylistButton', 'Download Main');
                        toolkist.html.RenderButton('.standardLeftPanel', 'legacyLevelsPlaylistButton', 'Download Legacy');

                        $('#mainLevelsButton').on('click', function()
                        {
                            $('#zdlLegacyList').hide();
                            $('#zdlScoreboard').hide();
                            $('#zdlMainList').show();
                        });

                        $('#legacyLevelsButton').on('click', function()
                        {                    
                            $('#zdlScoreboard').hide();
                            $('#zdlMainList').hide();
                            $('#zdlLegacyList').show();
                        });

                        $('#scoreboardButton').on('click', function()
                        {     
                            $('#zdlMainList').hide();
                            $('#zdlLegacyList').hide();
                            $('#zdlScoreboard').show();
                        });  

                        $('#mainLevelsPlaylistButton').on('click', function()
                        {
                            toolkist.fs.DirectDownload(mainPlaylist.name + ".zeeplist", mainPlaylist.ToJSON());
                        });

                        $('#legacyLevelsPlaylistButton').on('click', function()
                        {
                            toolkist.fs.DirectDownload(legacyPlaylist.name + ".zeeplist", legacyPlaylist.ToJSON());
                        });
                        
                        $('#zdlLoadingPage').hide();
                        $('#zdlMainList').show();
                    });
                });        
            });
        }
    }, useDummyData);
})

function GetScore(index)
{
    function generateY(x) {
        return x <= 25 ? 50 - 2 * (x - 1) : 2 * (x - 26);
    }

    var yPoints = generateY(index);
    return Math.round(500 / Math.pow(index, 0.2) - Math.pow(index, 1.35) + (yPoints * 2) - 99, 1);
}

function GetLevelRecords(list, onLoadedCallback)
{
    const hashes = list.map(level => level.hash);
    const levelURL = `https://jsonapi.zworpshop.com/levels?include=metadata&page[size]=100&filter=any(fileHash,'${hashes.join("','")}')`;
    const recordURL = `https://jsonapi.zeepkist-gtr.com/personalbests?include=record&page[size]=100&filter=any(level,'${hashes.join("','")}')`;

    toolkist.api.JSONAPIRequestAll(levelURL, function(allResponses)
    {
        var levelData = [];

        //Go over each response and extract all the levels.
        allResponses.forEach(response => 
        {
            //Go over each entry in the data array
            response.data.forEach(rd => 
            {
                //Get the data from the attributes.
                var level = {
                    name : rd.attributes.name,
                    creator: rd.attributes.fileAuthor,
                    fileAuthor: rd.attributes.fileAuthor,
                    hash: rd.attributes.fileHash,
                    file: rd.attributes.fileUrl,
                    image: rd.attributes.imageUrl,
                    workshopId: rd.attributes.workshopId,
                    uid: rd.attributes.fileUid
                };

                //Get the data from the the metadata.
                if(rd.attributes.hasOwnProperty('metadataId'))
                {
                    var metadata = response.included.find(inc => inc.id == rd.attributes.metadataId);
                    if(metadata != undefined)
                    {
                        level.blocks = metadata.attributes.blocks;
                        level.checkpoints = metadata.attributes.checkpoints;
                        level.authorTime = metadata.attributes.validation;
                    }
                }

                //Combine it with the data defined in the gists.
                var listLevelIndex = list.findIndex(l => {return l.hash === rd.attributes.fileHash});
                if(listLevelIndex != -1)
                {
                    var listLevel = list[listLevelIndex];
                    level.index = listLevelIndex + 1;
                    level.score = GetScore(level.index);

                    if(listLevel.manualCreators.length > 0)
                    {
                        level.creator = listLevel.manualCreators.join("<span class='orangeText'> & </span>");
                    }

                    level.records = [];

                    if(listLevel.manualRecords.length > 0)
                    {
                        listLevel.manualRecords.forEach(f => 
                        {
                            if(typeof f === 'object' && f !== null)
                            {
                                var record = {};
                                record.user = f.hasOwnProperty('user') ? f.user : 'undefined';
                                record.time = f.hasOwnProperty('time') ? f.time : -1;
                                record.splits = f.hasOwnProperty('splits') ? f.splits : "";
                                level.records.push(record);
                            }
                        });
                    }

                    if(listLevel.manualValidation != 0)
                    {
                        if(listLevel.manualValidation < 0)
                        {
                            level.authorTime = -1;
                        }
                        else
                        {
                            level.authorTime = listLevel.manualValidation;
                        }
                    }

                    level.description = listLevel.description;
                    level.tier = listLevel.tier;
                    level.displayName = listLevel.displayName;
                    levelData.push(level);
                }
                else
                {
                    console.logError("Can't find level in gist data...", "Hash: " + rd.attributes.fileHash);
                }                
            });
        });

        levelData.sort(function(a,b){
            return a.index - b.index;
        });

        //Now that all the level data is collected, get all records for the levels.
        toolkist.api.JSONAPIRequestAll(recordURL, function(allResponses)
        {
            //Go over each response
            allResponses.forEach(response =>
            {
                //Go over each record entry
                response.data.forEach(pb => 
                {
                    //Find the index of the level that this record belongs to.
                    var levelIndex = levelData.findIndex(l => { return l.hash == pb.attributes.level; })

                    //Level found
                    if(levelIndex != -1)
                    {
                        //Get the included record data for this personal best.
                        var record = response.included.find(inc => inc.id == pb.attributes.recordId);
                        if(record != undefined)
                        {
                            var playerName = playerData.find(p => p.id == pb.attributes.userId);
                            if(playerName != undefined)
                            {
                                playerName = playerName.name;
                            }

                            var recordData = {
                                user : playerName,
                                time: record.attributes.time,
                                splits: record.attributes.splits
                            };

                            levelData[levelIndex].records.push(recordData);
                        }                        
                    }
                });
            });

            // Go over all the levels one more time and sort the records
            levelData.forEach(lvl => {
                lvl.records.sort(function(a, b) {
                    // Check if either time is -1
                    if (a.time === -1 && b.time === -1) {
                        // If both times are -1, sort alphabetically by user
                        return a.user.localeCompare(b.user);
                    } else if (a.time === -1) {
                        // If only the first time is -1, place it at the bottom
                        return 1;
                    } else if (b.time === -1) {
                        // If only the second time is -1, place it at the bottom
                        return -1;
                    } else {
                        // Otherwise, sort by time
                        return a.time - b.time;
                    }
                });
            });

            onLoadedCallback(levelData);
        })
    });
}

function RenderZDLList(containerID, levelData, type)
{
    var usedTracks = [];
    var usedUids = [];

    var container = $(containerID);
    container.empty();

    levelData.forEach(level => 
    {
        if(!usedTracks.includes(level.hash) && !usedUids.includes(level.uid))
        {
            usedTracks.push(level.hash);      
            usedUids.push(level.uid);  

            //Main Row
            var row = $('<div>').addClass('zdl-row');

            var color = '#000000';
            if(gist.tiers.hasOwnProperty(level.tier))
            {
                color = gist.tiers[level.tier];
            }

            //Left Rank Section
            var rowRank = $('<div>').addClass('zdl-rank');
            rowRank.css({backgroundColor:color});

            if(type == 'main')
            {
                var index = $('<div>').addClass('zdl-index').append("<span>").text(level.index);
                var points = $('<div>').addClass('zdl-points').append($('<i>').addClass('fa fa-star')).append($('<br>')).append($('<span>').text(level.score));
            
                rowRank.append(index, points);
            }
            
            var steam = $('<div>').addClass('zdl-steam').on('click', function(){
                var workshopUrl = 'https://steamcommunity.com/sharedfiles/filedetails/?id=' + level.workshopId;
                window.open(workshopUrl, '_blank');
            });

            rowRank.append(steam);        
            row.append(rowRank);

            //Image
            var image = $('<img>').attr({src : level.image}).addClass('zdl-image');
            row.append(image);

            //Main content container
            var rowContent = $('<div>').addClass('zdl-content');
            rowContent.css({
                backgroundColor:color
            });

            var header = $('<div>').addClass('zdl-header');        
            var name = $('<span>').text(level.name);
            
            if(level.displayName != "")
            {
                name.text(level.displayName);
            }        
            
            var by = $('<span>').addClass('orangeText').text("by");
            var creator = $('<span>').html(level.creator);
            header.append(name, by, creator);

            var authorTimeText = level.authorTime == -1 ? "Unvalidated" : toolkist.util.ConvertSecondsToDisplayTime(level.authorTime);
            var authorTime = $('<div>').addClass('zdl-authorTime').append($('<div>').addClass('zdl-authorTime-medal')).append($('<span>').text(authorTimeText));
            var description = $('<div>').addClass('zdl-description').text(level.description);
            var records = $('<div>').addClass('zdl-records');     
            rowContent.append(header, authorTime, description, records);
            row.append(rowContent);

            //Record Table
            var recordsTable = $('<table>').addClass('zdl-record-table');
            records.append(recordsTable);

            var recordCounter = 1;

            level.records.forEach(r => 
            {
                var recrow = $('<tr>');
                var place = $('<td>').text(recordCounter).css({width: '20%'});
                var user = $('<td>').text(r.user).css({width: '40%'});
                var time = $('<td>').text(r.time == -1 ? "" : toolkist.util.ConvertSecondsToDisplayTime(r.time)).css({width: '40%'});
                recrow.append(place,user,time);
                recordsTable.append(recrow);
                recordCounter++;
            });       

            container.append(row);
        }
    });
}

function RenderZDLScoreboard(containerID, levelData) 
{    
    // Initialize variables
    const players = {};

    // Calculate players' scores and completions
    levelData.forEach(level => {
        level.records.forEach(record => {
            if (!players.hasOwnProperty(record.user)) {
                players[record.user] = {
                    user: record.user,
                    completed: 0,
                    score: 0
                };
            }

            players[record.user].completed++;
            players[record.user].score += level.score;
        });
    });

    // Convert players object to an array
    const playersArray = Object.values(players);

    // Sort players based on score first and then completions
    playersArray.sort((a, b) => {
        if (a.score !== b.score) {
            return b.score - a.score; // Sort by score
        } else {
            return b.completed - a.completed; // If scores are equal, sort by completions
        }
    });

    for(var i = 0; i < playersArray.length; i++)
    {
        playersArray[i].position = i + 1;
    }

    toolkist.html.RenderLeaderboard(playersArray, ['position','user','completed','score'], containerID, ["#", "Player", "Completed", "Score"]);
}
